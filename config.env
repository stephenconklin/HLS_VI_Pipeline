# config.env
# =================================================================
# HLS VI PIPELINE — CONFIGURATION
# =================================================================

# --- PROJECT PATHS ---
BASE_DIR="/Volumes/ConklinGeospatialData/Data/BioSCape_SA"
LOG_DIR="${BASE_DIR}/0_Logs"

# --- OUTPUT DIRECTORIES ---
RAW_HLS_DIR="${BASE_DIR}/1_Raw"
VI_OUTPUT_DIR="${BASE_DIR}/2_Interim/1_VI_Products"
NETCDF_DIR="${BASE_DIR}/2_Interim/2_NetCDF"
REPROJECTED_DIR="${BASE_DIR}/2_Interim/3_VI_Mean_Tiles"
REPROJECTED_DIR_OUTLIERS="${BASE_DIR}/2_Interim/4_VI_Outlier_Tiles"
MOSAIC_DIR="${BASE_DIR}/3_Out/1_Mosaic"
TIMESLICE_OUTPUT_DIR="${BASE_DIR}/3_Out/2_TimeSeries"
OUTLIER_GPKG_DIR="${BASE_DIR}/3_Out/3_Outlier_Points"

# --- PYTHON ENVIRONMENT ---
# Activate the hls_pipeline conda environment before running hls_pipeline.sh:
#   conda activate hls_pipeline && bash hls_pipeline.sh
PYTHON_EXEC="python"
export PYTHONUNBUFFERED=1

# --- PROCESSING PARAMETERS ---
NUM_WORKERS=8
CHUNK_SIZE=10
TARGET_CRS="EPSG:9221" # Albers (SA)
# TARGET_CRS="EPSG:6350" # Only applicable after STEP 03

# =================================================================
# OUTPUT FORMAT
# =================================================================
# NETCDF_COMPLEVEL — zlib compression level for NetCDF time-series files
#   (step 03). Range 0–9: 0 = no compression, 1 = fastest/least, 9 = most.
#   Level 1 gives substantial size reduction with minimal CPU cost; higher
#   levels rarely justify extra processing time for NaN-heavy float data.
NETCDF_COMPLEVEL=1

# GEOTIFF_COMPRESS — compression codec for all GeoTIFF outputs
#   (steps 02, 04–10). Must be supported by your GDAL build.
#   Options: LZW (default, fast, compatible), DEFLATE, ZSTD, NONE
GEOTIFF_COMPRESS="LZW"

# GEOTIFF_BLOCK_SIZE — internal tile block dimension for all tiled GeoTIFF
#   outputs (steps 04–10). Must be a power of two. 512 is standard for
#   desktop GIS; 256 is preferred for Cloud-Optimized GeoTIFFs (COGs).
GEOTIFF_BLOCK_SIZE=512

# =================================================================
# VEGETATION INDICES
# =================================================================
# Space-separated list of VIs to process end-to-end.
# Options: NDVI  EVI2  NIRv
# All listed VIs flow through every active pipeline step.
#
# NOTE: NDVI, EVI2, and NIRv all require only NIR + Red + Fmask — the default
#       band lists below are correct for all three. See the BAND SELECTION
#       section for a full per-VI breakdown and future EVI guidance.
# PROCESSED_VIS="NDVI EVI2 NIRv"
PROCESSED_VIS="NDVI"

# =================================================================
# PIPELINE STEP CONTROL
# =================================================================
# STEPS controls which pipeline stages run. Accepts:
#
#   Named steps (space-separated, any order, any combination):
#     download        Step 01 — Query NASA LP DAAC and download raw HLS bands
#     vi_calc         Step 02 — Compute VI GeoTIFFs from raw bands
#     netcdf          Step 03 — Aggregate VI GeoTIFFs into NetCDF time-series
#     mean_flat       Step 04 — Temporal mean per tile, reproject to TARGET_CRS
#     outlier_flat    Step 05 — Outlier mean + count per tile, reproject
#     mean_mosaic     Step 06 — Mosaic mean tiles into continent-wide GeoTIFF
#     outlier_mosaic  Step 07 — Mosaic outlier mean tiles
#     outlier_counts  Step 08 — Mosaic outlier count tiles
#     count_valid_mosaic Step 09 — CountValid mosaic across all download cycles;
#                               reads NetCDF files (Step 03); independent of
#                               TIMESLICE_WINDOWS and the timeseries step
#     timeseries      Step 10 — Custom time-window multi-band stacks
#     outlier_gpkg    Step 11 — Export per-pixel outlier observations (value,
#                               date, location) to a GeoPackage point vector
#                               file; output in OUTLIER_GPKG_DIR
#
#   Convenience aliases (expand to the step groups below):
#     all             All steps 01–11
#     products        Steps 02–11  (raw data already downloaded)
#     build_nc        Steps 01–03  (download → VI calc → NetCDF)
#     mosaics         Steps 06–08  (re-mosaic only, tiles already reprojected)
#     outliers        Steps 05+07+08+11  (re-run full outlier chain only)
#
# Examples:
#   Full pipeline from scratch:          STEPS="all"
#   Raw data exists, build everything:   STEPS="products"
#   Download through NetCDF only:        STEPS="build_nc"
#   Re-run only the time-series step:    STEPS="timeseries"
#   Re-mosaic after fixing a tile:       STEPS="mosaics"
#   Re-run full outlier chain:           STEPS="outliers"
#   Export outlier points only:          STEPS="outlier_gpkg"
#   Count valid obs mosaic only:         STEPS="count_valid_mosaic"
#   NetCDF through mean mosaic only:     STEPS="netcdf mean_flat mean_mosaic"
#   Add a new VI (NetCDFs exist):        STEPS="mean_flat outlier_flat mosaics timeseries"
STEPS="outlier_gpkg"

# =================================================================
# SPACE SAVER OPTIONS  (steps 01–03)
# =================================================================
# Space saver options only take effect when step 03 (netcdf) is
# included in the current STEPS run. Both options are safe to
# enable together.
#
#   SPACE_SAVER_REMOVE_RAW — delete the downloaded HLS band and
#     Fmask files (RAW_HLS_DIR) for each tile after its NetCDF
#     is built. The raw data is no longer needed once the NetCDF
#     time-series exists.
#
#   SPACE_SAVER_REMOVE_VI  — delete the per-granule VI GeoTIFF
#     files (VI_OUTPUT_DIR) for each tile after its NetCDF is
#     built. These intermediate files are superseded by the NetCDF.
#
SPACE_SAVER_REMOVE_RAW="TRUE"
SPACE_SAVER_REMOVE_VI="TRUE"

# SKIP_APPROVAL — set TRUE to bypass the download approval prompt.
# Use for automated or non-interactive pipeline runs (cron, CI, scripts).
# Default FALSE requires interactive confirmation before downloading.
SKIP_APPROVAL="FALSE"

# =================================================================
# DOWNLOAD SETTINGS
# =================================================================
CLOUD_COVERAGE_MAX=75
SPATIAL_COVERAGE_MIN=0

# --- BAND SELECTION ---
# Define which bands to download for each sensor (space-separated).
# Fmask is always required for cloud/shadow/snow/water masking.
#
# Band reference:
#   Sensor  Band   Wavelength    Role
#   ------  -----  ----------    ----
#   L30     B02    Blue          Only needed for 3-band EVI (not currently used)
#   L30     B04    Red           Required by all current VIs
#   L30     B05    NIR           Required by all current VIs
#   L30     Fmask  QA            Always required
#
#   S30     B02    Blue          Only needed for 3-band EVI (not currently used)
#   S30     B04    Red           Required by all current VIs
#   S30     B8A    NIR (narrow)  Required by all current VIs
#   S30     Fmask  QA            Always required
#
# Band requirements by VI:
#
#   VI      Formula                     L30 bands       S30 bands
#   ------  --------------------------  --------------  ---------------
#   NDVI    (NIR - Red) / (NIR + Red)   B05 B04 Fmask   B8A B04 Fmask
#   EVI2    2.5*(NIR-Red)/(NIR+2.4*Red  B05 B04 Fmask   B8A B04 Fmask
#             +1)
#   NIRv    NDVI * NIR                  B05 B04 Fmask   B8A B04 Fmask
#
#   [future 3-band EVI]                 B05 B04 B02     B8A B04 B02
#                                         Fmask           Fmask
#
# IMPORTANT: NDVI, EVI2, and NIRv all share the same band requirements,
# so the band lists below never need to change when switching between
# these three VIs. Only adding 3-band EVI would require adding B02.
#
# The pipeline startup validator (hls_pipeline.sh) will warn you at
# runtime if PROCESSED_VIS contains a VI whose required bands are
# missing from the lists below.
L30_BANDS="B05 B04 Fmask"
S30_BANDS="B8A B04 Fmask"

# =================================================================
# FMASK QUALITY MASKING
# =================================================================
MASK_CIRRUS="TRUE"          # Bit 0
MASK_CLOUD="TRUE"           # Bit 1
MASK_ADJACENT_CLOUD="TRUE"  # Bit 2
MASK_CLOUD_SHADOW="TRUE"    # Bit 3
MASK_SNOW_ICE="TRUE"        # Bit 4
MASK_WATER="TRUE"           # Bit 5

# Aerosol masking mode:
#   HIGH     → mask only High aerosol (general use)
#   MODERATE → mask High + Moderate   (recommended for VIs)
#   LOW      → mask all non-zero aerosol
#   NONE     → no aerosol masking
MASK_AEROSOL_MODE="MODERATE"

# HLS surface reflectance scale factor (do not change).
HLS_SCALE_FACTOR=0.0001

# =================================================================
# PER-VI VALID RANGE BOUNDS
# =================================================================
# Pixels outside these bounds are treated as outliers in steps 04,
# 05, 09, 10, and 11. Format: "min,max" (no spaces).
#
# Scientific basis:
#   NDVI  — bounded by definition to [-1, 1]. Ratio of two bands of
#             equal magnitude at the extremes. -1 to 1 is exact.
#
#   EVI2  — 2.5*(NIR-Red)/(NIR + 2.4*Red + 1). The +1 stabiliser
#             prevents division by zero but does not bound the result
#             to [-1, 1]. Over bright/noisy surfaces it can exceed 1.
#             Practical vegetation range is [-0.2, 1.0] but clamping
#             at 1.0 clips high-biomass pixels. [-1, 2] captures all
#             physically plausible values while rejecting noise.
#
#   NIRv  — NDVI * NIR (scaled reflectance). Unbounded by formula,
#             but with HLS scale factor applied (0.0001) NIR is in
#             [0, 1], making NIRv bounded by [-1, 1] in practice.
#             Negative NIRv requires negative NDVI (physically rare
#             over land). Dense tropical canopy can reach ~0.5–0.6.
#             [-0.5, 1] rejects implausible negatives while keeping
#             all legitimate high-vegetation values.
#
# Adjust these thresholds if your study region has atypical surface
# conditions (e.g. snow/ice, salt flats, open water).
VALID_RANGE_NDVI="-1,1"
VALID_RANGE_EVI2="-1,2"
VALID_RANGE_NIRv="-0.5,1"

# =================================================================
# TILE LIST
# =================================================================
# Full Pennsylvania Mtn Laurel Set:
# HLS_TILES="17TNE 17TNF 17TNG 17TPE 17TPF 17TPG 17TQE 17TQF 17TQG 18TTK 18TTL 18TTM 18TUK 18TUL 18TUM 18TVK 18TVL 18TVM 18TWK 18TWL 17SND 17SPD 17SQD 18STJ 18SUJ 18SVJ"

# Full BioSCape South Africa Set:
HLS_TILES="34HBH 34HBJ 34HBK 34HCG 34HCH 34HCJ 34HCK 34HDG 34HDH 34HDJ 34HDK 34HEG 34HEH 34HEJ 34HFH 34HFJ 34HGH 34JBL 34JCL 35HKC 35HLC 35HMC 35HMD"


# =================================================================
# DOWNLOAD CYCLES
# =================================================================
# Pennsylvania Download Cycles:
# DOWNLOAD_CYCLES="2015-12-01|2016-03-31 \
#                 2016-12-01|2017-03-31 \
#                 2017-12-01|2018-03-31 \
#                 2018-12-01|2019-03-31 \
#                 2019-12-01|2020-03-31 \
#                 2020-12-01|2021-03-31"

# Bioscapes South Africa Download Cycles:
DOWNLOAD_CYCLES="2016-01-01|2025-12-31"

# =================================================================
# TIME-SERIES / CUSTOM WINDOW MOSAICS  (step: timeseries)
# =================================================================
# Only runs when "timeseries" (or an alias containing it) is in STEPS.
TIMESLICE_ENABLED="TRUE"

# Statistic per pixel per window. Currently supported: mean
TIMESLICE_STAT="mean"

# TIMESLICE_WINDOWS — space-separated list of named date windows.
#
# Format:  label:YYYY-MM-DD|YYYY-MM-DD
#   label  : alphanumeric + underscores only (becomes band name in output stack)
#   dates  : start | end, inclusive
#
# Examples:
#
#   South Africa wet/dry seasons:
#   TIMESLICE_WINDOWS="wet_2020:2020-11-01|2021-04-30 dry_2021:2021-05-01|2021-10-31 wet_2021:2021-11-01|2022-04-30 dry_2022:2022-05-01|2022-10-31"
#
#   Monthly slices for outlier forensics:
#   TIMESLICE_WINDOWS="jan_2021:2021-01-01|2021-01-31 feb_2021:2021-02-01|2021-02-28 mar_2021:2021-03-01|2021-03-31"
#
#   Annual composites:
#   TIMESLICE_WINDOWS="yr_2016:2016-01-01|2016-12-31 yr_2017:2017-01-01|2017-12-31 yr_2018:2018-01-01|2018-12-31"
#
TIMESLICE_WINDOWS="Winter_15_16:2015-12-01|2016-03-31 \
                Winter_16_17:2016-12-01|2017-03-31 \
                Winter_17_18:2017-12-01|2018-03-31 \
                Winter_18_19:2018-12-01|2019-03-31 \
                Winter_19_20:2019-12-01|2020-03-31 \
                Winter_20_21:2020-12-01|2021-03-31"